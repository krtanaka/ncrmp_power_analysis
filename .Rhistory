library(SimSurvey)
library(raster)
library(data.table)
library(ggplot2)
library(dplyr)
library(ggdark)
library(patchwork)
rm(list = ls())
set.seed(50)
# pick an island ----------------------------------------------------------
island = c("Hawaii", "Kahoolawe", "Kauai", "Lanai", "Maui", "Molokai", "Niihau", "Oahu" )[sample(1:8, 1)]
load(paste0("data/survey_grid_w_sector_reef/survey_grid_", island, ".RData"))
print(island)
# bring in sim$ as a place holder -----------------------------------------
sim = sim_abundance(years = 2000:2020,
ages = 1:2,
R = sim_R(log_mean = log(50), log_sd = 0.8),
Z = sim_Z(log_mean = log(0.2))) %>%
sim_distribution(grid = survey_grid_kt)
library(sdmTMB)
library(dplyr)
library(ggplot2)
library(rgdal)
library(colorRamps)
library(patchwork)
rm(list = ls())
# 4 functional groups
# live coral cover
# adult juvenile density
# for Uku:
# Total numerical density estimates (individuals per 100 m2) were obtained by dividing fish counts in each survey by the survey area (353 m2 from two 15-m diameter survey cylinders) and multiplying by 100. - Nadon et al. 2020
region = "MHI"
uku_or_not = F
# load("data/ALL_REA_FISH_RAW.rdata")
# df %>%
#   subset(REGION == region) %>%
#   group_by(TAXONNAME) %>%
#   summarise(n = sum(BIOMASS_G_M2, na.rm = T)) %>%
#   # summarise(n = sum(COUNT, na.rm = T)) %>%
#   mutate(freq = n/sum(n)) %>%
#   arrange(desc(freq)) %>%
#   top_n(5)
islands = c("Kauai", #1
"Lehua", #2
"Niihau", #3
"Kaula", #4
"Oahu", #5
"Molokai", #6
"Maui", #7
"Lanai", #8
"Molokini", #9
"Kahoolawe", #10
"Hawaii")[5]
response_variable = "fish_count";      sp = ifelse(uku_or_not == T, "Aprion virescens", "Chromis vanderbilti")
response_variable = "fish_biomass";    sp = ifelse(uku_or_not == T, "Aprion virescens", "Acanthurus olivaceus")
response_variable = "trophic_biomass"; sp = c("PISCIVORE", "PLANKTIVORE", "PRIMARY", "SECONDARY")[2]
response_variable = "coral_cover";     sp = c("CCA", "CORAL", "EMA", "HAL", "I", "MA", "SC", "SED", "TURF")[2]
response_variable = "coral_density";   sp = c("AdColDen", "JuvColDen")[1]
library(SimSurvey)
library(raster)
library(data.table)
library(ggplot2)
library(dplyr)
library(ggdark)
library(patchwork)
rm(list = ls())
set.seed(50)
# pick an island ----------------------------------------------------------
island = c("Hawaii", "Kahoolawe", "Kauai", "Lanai", "Maui", "Molokai", "Niihau", "Oahu" )[sample(1:8, 1)]
library(sdmTMB)
library(dplyr)
library(ggplot2)
library(rgdal)
library(colorRamps)
library(patchwork)
rm(list = ls())
region = "MHI"
uku_or_not = F
islands = c("Kauai", #1
"Lehua", #2
"Niihau", #3
"Kaula", #4
"Oahu", #5
"Molokai", #6
"Maui", #7
"Lanai", #8
"Molokini", #9
"Kahoolawe", #10
"Hawaii")[5]
response_variable = "fish_count";      sp = ifelse(uku_or_not == T, "Aprion virescens", "Chromis vanderbilti")
response_variable = "fish_biomass";    sp = ifelse(uku_or_not == T, "Aprion virescens", "Acanthurus olivaceus")
response_variable = "trophic_biomass"; sp = c("PISCIVORE", "PLANKTIVORE", "PRIMARY", "SECONDARY")[2]
response_variable = "coral_cover";     sp = c("CCA", "CORAL", "EMA", "HAL", "I", "MA", "SC", "SED", "TURF")[2]
response_variable = "coral_density";   sp = c("AdColDen", "JuvColDen")[1]
if (response_variable == "fish_count") {
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
# mutate(response = ifelse(TAXONNAME == sp, COUNT*100, 0)) %>%
mutate(response = ifelse(TAXONNAME == sp, COUNT, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df %>% ggplot(aes(response)) + geom_histogram() +
df %>% group_by(OBS_YEAR) %>% summarise(n = mean(response)) %>% ggplot(aes(OBS_YEAR, n)) + geom_line()
}
if (response_variable == "fish_biomass") {
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2, 0)) %>%
# mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2*0.001, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df %>% ggplot(aes(response)) + geom_histogram() +
df %>% group_by(OBS_YEAR) %>% summarise(n = median(response)) %>% ggplot(aes(OBS_YEAR, n)) + geom_line()
}
response_variable = "fish_count";      sp = ifelse(uku_or_not == T, "Aprion virescens", "Chromis vanderbilti")
library(sdmTMB)
library(dplyr)
library(ggplot2)
library(rgdal)
library(colorRamps)
library(patchwork)
rm(list = ls())
# 4 functional groups
# live coral cover
# adult juvenile density
# for Uku:
# Total numerical density estimates (individuals per 100 m2) were obtained by dividing fish counts in each survey by the survey area (353 m2 from two 15-m diameter survey cylinders) and multiplying by 100. - Nadon et al. 2020
region = "MHI"
uku_or_not = F
# load("data/ALL_REA_FISH_RAW.rdata")
# df %>%
#   subset(REGION == region) %>%
#   group_by(TAXONNAME) %>%
#   summarise(n = sum(BIOMASS_G_M2, na.rm = T)) %>%
#   # summarise(n = sum(COUNT, na.rm = T)) %>%
#   mutate(freq = n/sum(n)) %>%
#   arrange(desc(freq)) %>%
#   top_n(5)
islands = c("Kauai", #1
"Lehua", #2
"Niihau", #3
"Kaula", #4
"Oahu", #5
"Molokai", #6
"Maui", #7
"Lanai", #8
"Molokini", #9
"Kahoolawe", #10
"Hawaii")[5]
response_variable = "fish_count";      sp = ifelse(uku_or_not == T, "Aprion virescens", "Chromis vanderbilti")
if (response_variable == "fish_count") {
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
# mutate(response = ifelse(TAXONNAME == sp, COUNT*100, 0)) %>%
mutate(response = ifelse(TAXONNAME == sp, COUNT, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df %>% ggplot(aes(response)) + geom_histogram() +
df %>% group_by(OBS_YEAR) %>% summarise(n = mean(response)) %>% ggplot(aes(OBS_YEAR, n)) + geom_line()
}
if (response_variable == "fish_biomass") {
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2, 0)) %>%
# mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2*0.001, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df %>% ggplot(aes(response)) + geom_histogram() +
df %>% group_by(OBS_YEAR) %>% summarise(n = median(response)) %>% ggplot(aes(OBS_YEAR, n)) + geom_line()
}
if (response_variable == "trophic_biomass") {
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate(response = ifelse(TROPHIC_MONREP == sp, BIOMASS_G_M2*0.001, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df %>% ggplot(aes(response)) + geom_histogram() +
df %>% group_by(OBS_YEAR) %>% summarise(n = median(response)) %>% ggplot(aes(OBS_YEAR, n)) + geom_line()
}
if (response_variable == "coral_cover") {
load("data/BenthicCover_2010-2020_Tier1_SITE_MHI_w_CRM.RData") #live coral cover, only for MHI, with CRM_Bathy data
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate(response = CORAL,
DEPTH = ifelse(DEPTH_e == 0, DEPTH_e*-1 + 0.1, DEPTH_e*-1)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = median(response, na.rm = T),
n = n())
hist(df$response, main = paste0(sp, "_cover"))
}
if (response_variable == "coral_density") {
load("data/BenthicREA_sitedata_TAXONCODE.RData_MHI_w_CRM.RData") #live coral cover, only for MHI, with CRM_Bathy data
if (sp == "AdColDen") df = df %>% mutate(response = AdColDen)
if (sp == "JuvColDen") df = df %>% mutate(response = JuvColDen)
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate( DEPTH = ifelse(DEPTH_e == 0, DEPTH_e*-1 + 0.1, DEPTH_e*-1)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
hist(df$response, main = paste0(sp, "_coral_density"))
}
# north-south gradient
df %>%
group_by(ISLAND) %>%
summarise(n = mean(response, na.rm = T),
lat = mean(LATITUDE)) %>%
arrange(desc(lat))
zone <- (floor((df$LONGITUDE[1] + 180)/6) %% 60) + 1
xy_utm = as.data.frame(cbind(utm = project(as.matrix(df[, c("LONGITUDE", "LATITUDE")]), paste0("+proj=utm +units=km +zone=", zone))))
colnames(xy_utm) = c("X", "Y")
df = cbind(df, xy_utm)
# n_knots = 300
n_knots = 100 # a coarse mesh for speed
rea_spde <- make_mesh(df, c("X", "Y"), n_knots = n_knots, type = "cutoff_search")
# png(paste0("outputs/SPDE_mesh_field_", n_knots, ".png"), height = 5, width = 5, units = "in", res = 100)
# par(mfrow = c(1,2))
# plot(xy_utm, pch = ".", bty = 'n')
plot(rea_spde, pch = ".", bty = "n"); axis(1); axis(2)
df
load("data/rea/ALL_REA_FISH_RAW.rdata")
df = df %>%
subset(REGION == region & ISLAND %in% islands) %>%
mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2, 0)) %>%
# mutate(response = ifelse(TAXONNAME == sp, BIOMASS_G_M2*0.001, 0)) %>%
group_by(LONGITUDE, LATITUDE, ISLAND, OBS_YEAR, DATE_, DEPTH) %>%
summarise(response = sum(response, na.rm = T))
df
